# Mosquitto Configuration for Sengled Local Server
# Generated from template - do not edit directly

# ==============================================================================
# Basic Configuration
# ==============================================================================

# Run as mosquitto user
user mosquitto

# Process ID file (in writable location)
pid_file /data/mosquitto/mosquitto.pid

# Persistence settings
persistence true
persistence_location /data/mosquitto/

# Logging
log_dest file /data/mosquitto/mosquitto.log
log_dest stdout
log_type error
log_type warning
log_type notice
log_type information
{% if log_level == 'DEBUG' %}
log_type debug
log_type subscribe
log_type unsubscribe
log_type websockets
log_type all
{% endif %}
log_timestamp true

# Connection messages
connection_messages true

{% if log_level == 'DEBUG' %}
# Debug: Enhanced logging for troubleshooting
# log_type debug is already included above, no need to repeat
{% endif %}

# ==============================================================================
# Network Configuration
# ==============================================================================

# MQTT listener without SSL (for local debugging)
listener 1883
protocol mqtt
allow_anonymous false

# MQTT listener with SSL (for Sengled bulbs) - simplified config
listener 28527
allow_anonymous true
protocol mqtt
cafile {{ certs_dir }}/ca.crt
certfile {{ certs_dir }}/server.crt
keyfile {{ certs_dir }}/server.key

# ==============================================================================
# Security and Access Control
# ==============================================================================

# Password file removed - only using ACL-based access control
# Bridge authentication is handled separately in bridge configuration

# Access control list
acl_file /usr/local/mosquitto/acl.conf

# ==============================================================================
# Bridge Configuration (if enabled)
# ==============================================================================

{% if enable_bridge and mqtt_broker_host %}
# Bridge to Home Assistant MQTT broker
connection homeassistant_bridge
address {{ mqtt_broker_host }}:{{ mqtt_broker_port }}

# Authentication for bridge connection
{% if mqtt_username %}
username {{ mqtt_username }}
{% endif %}
{% if mqtt_password %}
password {{ mqtt_password }}
{% endif %}

# SSL/TLS settings for bridge
{% if mqtt_ssl %}
bridge_cafile /ssl/ca.crt
bridge_certfile /ssl/cert.crt
bridge_keyfile /ssl/key.key
bridge_tls_version tlsv1.2
{% endif %}

# Topic patterns to bridge  
# Bridge all wifielement topics (Sengled bulb data)
# Use QoS 1 to preserve acknowledgments for commands
topic wifielement/# both 1

# Bridge settings
cleansession false
try_private false
notifications false
bridge_protocol_version mqttv311
bridge_attempt_unsubscribe false
restart_timeout 30
keepalive_interval 60

# Local prefix (optional, can help organize topics)
# topic wifielement/# both 0 sengled/ ""

{% endif %}

# ==============================================================================
# Performance Tuning
# ==============================================================================

# Maximum concurrent clients
max_connections -1

# Message size limits (using mosquitto default: 0 = accept all valid MQTT messages)

# Keep alive settings
keepalive_interval 60
max_keepalive 65535

# Queue settings
max_queued_messages 1000
max_inflight_messages 20

# Memory limits
memory_limit 0
persistent_client_expiration 1h

# ==============================================================================
# WebSocket Support (optional)
# ==============================================================================

# WebSocket listener for web-based clients
listener 9001
protocol websockets
socket_domain ipv4

# ==============================================================================
# Status and Statistics
# ==============================================================================

# Enable $SYS tree for monitoring
sys_interval 10

# ==============================================================================
# Plugin Support (if needed in future)
# ==============================================================================

# plugin_dir /usr/lib/mosquitto/plugins/